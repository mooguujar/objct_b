# 数据库设计文档

## 一、数据库概述

本文档定义了岛屿社交平台的完整数据库设计，包括所有数据表结构、字段定义、索引设计、外键关系和 Prisma Schema。

**参考文档：**
- `产品构想和规划书.md` 第五章"技术架构"中的数据库设计部分（第601-658行）
- `产品构想和规划书.md` 第四章"核心功能模块"（第427-565行）

## 二、数据库 ER 图

```mermaid
erDiagram
    User ||--o{ Post : "发布"
    User ||--o{ Comment : "评论"
    User ||--o{ Follow : "关注/被关注"
    User ||--o{ IslandMember : "加入"
    User ||--o{ Island : "创建"
    User ||--o{ Notification : "接收"
    User ||--o{ CoinTransaction : "交易"
    User ||--o{ CreatorApplication : "申请"
    User ||--o{ PostLike : "点赞"
    User ||--o{ PostCollect : "收藏"
    User ||--o{ CommentLike : "点赞评论"
    User ||--o{ PageView : "访问"
    User ||--o{ ClickEvent : "点击"
    User ||--o{ UserBehavior : "行为"
    
    Island ||--o{ Post : "包含"
    Island ||--o{ IslandMember : "成员"
    Island }o--|| User : "拥有者"
    
    Post ||--o{ Comment : "评论"
    Post ||--o{ PostLike : "点赞"
    Post ||--o{ PostCollect : "收藏"
    
    Comment ||--o{ Comment : "回复"
    Comment ||--o{ CommentLike : "点赞"
    
    IslandMember }o--|| Island : "属于"
    IslandMember }o--|| User : "用户"
    
    Notification }o--|| User : "接收者"
    
    CoinTransaction }o--|| User : "用户"
    
    CreatorApplication }o--|| User : "申请人"
```

## 三、数据表详细设计

### 1. 用户表（User）

**表名：** `user`  
**用途：** 存储用户基本信息

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 用户ID |
| username | VARCHAR(50) | UNIQUE, NOT NULL | - | 用户名（登录用） |
| nickname | VARCHAR(50) | NOT NULL | - | 昵称 |
| avatar | VARCHAR(500) | NULL | NULL | 头像URL |
| phone | VARCHAR(20) | UNIQUE, NULL | NULL | 手机号 |
| email | VARCHAR(100) | UNIQUE, NULL | NULL | 邮箱 |
| password_hash | VARCHAR(255) | NOT NULL | - | 密码哈希 |
| bio | TEXT | NULL | NULL | 个人简介 |
| background_image | VARCHAR(500) | NULL | NULL | 个人主页背景图 |
| gender | TINYINT | NULL | NULL | 性别：0-未知，1-男，2-女 |
| birthday | DATE | NULL | NULL | 生日 |
| role | ENUM | NOT NULL | 'user' | 角色：user-普通用户，creator-创作者，admin-管理员 |
| status | ENUM | NOT NULL | 'active' | 状态：active-正常，banned-封禁，deleted-已删除 |
| is_verified | BOOLEAN | NOT NULL | false | 是否认证 |
| coin_balance | DECIMAL(10,2) | NOT NULL | 0.00 | 金币余额 |
| follow_count | INT UNSIGNED | NOT NULL | 0 | 关注数 |
| follower_count | INT UNSIGNED | NOT NULL | 0 | 粉丝数 |
| post_count | INT UNSIGNED | NOT NULL | 0 | 帖子数 |
| like_count | INT UNSIGNED | NOT NULL | 0 | 获赞数 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_username (username)
- UNIQUE KEY uk_phone (phone)
- UNIQUE KEY uk_email (email)
- KEY idx_status (status)
- KEY idx_role (role)
- KEY idx_created_at (created_at)

### 2. 岛屿表（Island）

**表名：** `island`  
**用途：** 存储岛屿（社区）信息

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 岛屿ID |
| name | VARCHAR(100) | NOT NULL | - | 岛屿名称 |
| description | TEXT | NULL | NULL | 岛屿简介 |
| cover | VARCHAR(500) | NULL | NULL | 封面图URL |
| avatar | VARCHAR(500) | NULL | NULL | 头像URL |
| category | VARCHAR(50) | NOT NULL | - | 分类（财经/体育/颜值/游戏/美食等） |
| owner_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 岛主ID（关联User） |
| price | DECIMAL(10,2) | NOT NULL | 0.00 | 加入价格（0表示免费） |
| member_count | INT UNSIGNED | NOT NULL | 0 | 成员数 |
| post_count | INT UNSIGNED | NOT NULL | 0 | 帖子数 |
| status | ENUM | NOT NULL | 'pending' | 状态：pending-待审核，active-正常，banned-封禁，deleted-已删除 |
| is_verified | BOOLEAN | NOT NULL | false | 是否认证 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_owner_id (owner_id)
- KEY idx_category (category)
- KEY idx_status (status)
- KEY idx_created_at (created_at)
- FOREIGN KEY (owner_id) REFERENCES user(id) ON DELETE CASCADE

### 3. 帖子表（Post）

**表名：** `post`  
**用途：** 存储用户发布的帖子/动态

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 帖子ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 发布者ID（关联User） |
| island_id | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 所属岛屿ID（NULL表示个人动态） |
| title | VARCHAR(200) | NULL | NULL | 标题 |
| content | TEXT | NULL | NULL | 内容 |
| media_type | ENUM | NOT NULL | 'text' | 媒体类型：text-纯文字，image-图片，video-视频，mixed-混合 |
| media_urls | JSON | NULL | NULL | 媒体文件URL数组（JSON格式） |
| like_count | INT UNSIGNED | NOT NULL | 0 | 点赞数 |
| comment_count | INT UNSIGNED | NOT NULL | 0 | 评论数 |
| collect_count | INT UNSIGNED | NOT NULL | 0 | 收藏数 |
| view_count | INT UNSIGNED | NOT NULL | 0 | 浏览数 |
| share_count | INT UNSIGNED | NOT NULL | 0 | 分享数 |
| status | ENUM | NOT NULL | 'active' | 状态：active-正常，pending-待审核，banned-封禁，deleted-已删除 |
| is_top | BOOLEAN | NOT NULL | false | 是否置顶 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_island_id (island_id)
- KEY idx_status (status)
- KEY idx_created_at (created_at)
- KEY idx_media_type (media_type)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (island_id) REFERENCES island(id) ON DELETE SET NULL

### 4. 评论表（Comment）

**表名：** `comment`  
**用途：** 存储帖子评论

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 评论ID |
| post_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 帖子ID（关联Post） |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 评论者ID（关联User） |
| content | TEXT | NOT NULL | - | 评论内容 |
| parent_id | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 父评论ID（NULL表示顶级评论，用于回复） |
| like_count | INT UNSIGNED | NOT NULL | 0 | 点赞数 |
| status | ENUM | NOT NULL | 'active' | 状态：active-正常，banned-封禁，deleted-已删除 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_post_id (post_id)
- KEY idx_user_id (user_id)
- KEY idx_parent_id (parent_id)
- KEY idx_created_at (created_at)
- FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (parent_id) REFERENCES comment(id) ON DELETE CASCADE

### 5. 关注表（Follow）

**表名：** `follow`  
**用途：** 存储用户关注关系

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 关注关系ID |
| follower_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 关注者ID（关联User） |
| following_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 被关注者ID（关联User） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_follow (follower_id, following_id)
- KEY idx_follower_id (follower_id)
- KEY idx_following_id (following_id)
- FOREIGN KEY (follower_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (following_id) REFERENCES user(id) ON DELETE CASCADE

### 6. 加入岛屿表（IslandMember）

**表名：** `island_member`  
**用途：** 存储用户加入岛屿的关系

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 关系ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 用户ID（关联User） |
| island_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 岛屿ID（关联Island） |
| join_type | ENUM | NOT NULL | 'free' | 加入类型：free-免费，paid-付费 |
| paid_amount | DECIMAL(10,2) | NOT NULL | 0.00 | 付费金额 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 加入时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_member (user_id, island_id)
- KEY idx_user_id (user_id)
- KEY idx_island_id (island_id)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (island_id) REFERENCES island(id) ON DELETE CASCADE

### 7. 通知表（Notification）

**表名：** `notification`  
**用途：** 存储系统通知和互动通知

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 通知ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 接收者ID（关联User） |
| type | ENUM | NOT NULL | - | 通知类型：system-系统通知，interaction-互动通知，payment-付费通知 |
| title | VARCHAR(200) | NOT NULL | - | 通知标题 |
| content | TEXT | NULL | NULL | 通知内容 |
| related_id | BIGINT UNSIGNED | NULL | NULL | 关联ID（如帖子ID、评论ID等） |
| related_type | VARCHAR(50) | NULL | NULL | 关联类型（post/comment/island等） |
| is_read | BOOLEAN | NOT NULL | false | 是否已读 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_type (type)
- KEY idx_is_read (is_read)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE

### 8. 金币交易表（CoinTransaction）

**表名：** `coin_transaction`  
**用途：** 存储金币交易记录

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 交易ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 用户ID（关联User） |
| type | ENUM | NOT NULL | - | 交易类型：recharge-充值，consume-消费，reward-奖励，refund-退款 |
| amount | DECIMAL(10,2) | NOT NULL | - | 交易金额（正数表示增加，负数表示减少） |
| balance | DECIMAL(10,2) | NOT NULL | - | 交易后余额 |
| description | VARCHAR(500) | NULL | NULL | 交易描述 |
| related_id | BIGINT UNSIGNED | NULL | NULL | 关联ID（如岛屿ID、订单ID等） |
| related_type | VARCHAR(50) | NULL | NULL | 关联类型（island/order等） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_type (type)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE

### 9. 页面访问统计表（PageView）

**表名：** `page_view`  
**用途：** 存储页面访问统计

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 用户ID（未登录为NULL，关联User） |
| page_path | VARCHAR(500) | NOT NULL | - | 页面路径 |
| page_title | VARCHAR(200) | NULL | NULL | 页面标题 |
| device_type | VARCHAR(50) | NULL | NULL | 设备类型（mobile/desktop/tablet） |
| platform | VARCHAR(50) | NULL | NULL | 平台（app/web） |
| referrer | VARCHAR(500) | NULL | NULL | 来源页面 |
| stay_duration | INT UNSIGNED | NULL | NULL | 停留时长（秒） |
| ip_address | VARCHAR(50) | NULL | NULL | IP地址 |
| user_agent | VARCHAR(500) | NULL | NULL | 用户代理 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 访问时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_page_path (page_path)
- KEY idx_created_at (created_at)
- KEY idx_platform (platform)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE SET NULL

### 10. 点击事件统计表（ClickEvent）

**表名：** `click_event`  
**用途：** 存储点击事件统计

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 用户ID（未登录为NULL，关联User） |
| event_type | VARCHAR(50) | NOT NULL | - | 事件类型（button_click/card_click/link_click等） |
| element_id | VARCHAR(200) | NULL | NULL | 元素ID |
| element_type | VARCHAR(50) | NULL | NULL | 元素类型（button/card/link等） |
| page_path | VARCHAR(500) | NOT NULL | - | 页面路径 |
| click_position_x | INT UNSIGNED | NULL | NULL | 点击位置X坐标 |
| click_position_y | INT UNSIGNED | NULL | NULL | 点击位置Y坐标 |
| related_id | BIGINT UNSIGNED | NULL | NULL | 关联ID（如帖子ID、用户ID等） |
| related_type | VARCHAR(50) | NULL | NULL | 关联类型（post/user/island等） |
| ip_address | VARCHAR(50) | NULL | NULL | IP地址 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 点击时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_event_type (event_type)
- KEY idx_page_path (page_path)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE SET NULL

### 11. 用户行为统计表（UserBehavior）

**表名：** `user_behavior`  
**用途：** 存储用户行为统计

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 记录ID |
| user_id | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 用户ID（未登录为NULL，关联User） |
| behavior_type | VARCHAR(50) | NOT NULL | - | 行为类型（like/comment/share/collect/view等） |
| target_type | VARCHAR(50) | NOT NULL | - | 目标类型（post/comment/user/island等） |
| target_id | BIGINT UNSIGNED | NOT NULL | - | 目标ID |
| page_path | VARCHAR(500) | NULL | NULL | 页面路径 |
| device_info | JSON | NULL | NULL | 设备信息（JSON格式） |
| ip_address | VARCHAR(50) | NULL | NULL | IP地址 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 行为时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_behavior_type (behavior_type)
- KEY idx_target (target_type, target_id)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE SET NULL

### 12. 创作者申请表（CreatorApplication）

**表名：** `creator_application`  
**用途：** 存储创作者申请信息

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 申请ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 申请人ID（关联User） |
| real_name | VARCHAR(50) | NULL | NULL | 真实姓名 |
| id_card | VARCHAR(50) | NULL | NULL | 身份证号 |
| phone | VARCHAR(20) | NULL | NULL | 联系电话 |
| email | VARCHAR(100) | NULL | NULL | 邮箱 |
| bio | TEXT | NULL | NULL | 个人简介 |
| qualification_urls | JSON | NULL | NULL | 资质证明文件URL数组（JSON格式） |
| status | ENUM | NOT NULL | 'pending' | 状态：pending-待审核，approved-已通过，rejected-已拒绝 |
| reject_reason | TEXT | NULL | NULL | 拒绝原因 |
| reviewed_by | BIGINT UNSIGNED | NULL, FOREIGN KEY | NULL | 审核人ID（关联User） |
| reviewed_at | DATETIME | NULL | NULL | 审核时间 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 申请时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- PRIMARY KEY (id)
- KEY idx_user_id (user_id)
- KEY idx_status (status)
- KEY idx_created_at (created_at)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (reviewed_by) REFERENCES user(id) ON DELETE SET NULL

### 13. 帖子点赞表（PostLike）

**表名：** `post_like`  
**用途：** 存储帖子点赞关系

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 点赞ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 用户ID（关联User） |
| post_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 帖子ID（关联Post） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 点赞时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_like (user_id, post_id)
- KEY idx_user_id (user_id)
- KEY idx_post_id (post_id)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE

### 14. 帖子收藏表（PostCollect）

**表名：** `post_collect`  
**用途：** 存储帖子收藏关系

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 收藏ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 用户ID（关联User） |
| post_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 帖子ID（关联Post） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 收藏时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_collect (user_id, post_id)
- KEY idx_user_id (user_id)
- KEY idx_post_id (post_id)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (post_id) REFERENCES post(id) ON DELETE CASCADE

### 15. 评论点赞表（CommentLike）

**表名：** `comment_like`  
**用途：** 存储评论点赞关系

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT UNSIGNED | PRIMARY KEY, AUTO_INCREMENT | - | 点赞ID |
| user_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 用户ID（关联User） |
| comment_id | BIGINT UNSIGNED | NOT NULL, FOREIGN KEY | - | 评论ID（关联Comment） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 点赞时间 |

**索引：**
- PRIMARY KEY (id)
- UNIQUE KEY uk_comment_like (user_id, comment_id)
- KEY idx_user_id (user_id)
- KEY idx_comment_id (comment_id)
- FOREIGN KEY (user_id) REFERENCES user(id) ON DELETE CASCADE
- FOREIGN KEY (comment_id) REFERENCES comment(id) ON DELETE CASCADE

## 四、Prisma Schema 设计

```prisma
// Prisma Schema 文件：backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  username        String    @unique @db.VarChar(50)
  nickname        String    @db.VarChar(50)
  avatar          String?   @db.VarChar(500)
  phone           String?   @unique @db.VarChar(20)
  email           String?   @unique @db.VarChar(100)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  bio             String?   @db.Text
  backgroundImage String?   @map("background_image") @db.VarChar(500)
  gender          Int?      @default(0) @db.TinyInt
  birthday        DateTime? @db.Date
  role            UserRole  @default(user)
  status          UserStatus @default(active)
  isVerified      Boolean   @default(false) @map("is_verified")
  coinBalance     Decimal   @default(0) @map("coin_balance") @db.Decimal(10, 2)
  followCount     Int       @default(0) @map("follow_count") @db.UnsignedInt
  followerCount   Int       @default(0) @map("follower_count") @db.UnsignedInt
  postCount       Int       @default(0) @map("post_count") @db.UnsignedInt
  likeCount       Int       @default(0) @map("like_count") @db.UnsignedInt
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关联关系
  posts              Post[]
  comments           Comment[]
  following          Follow[] @relation("Follower")
  followers          Follow[] @relation("Following")
  ownedIslands       Island[]
  islandMemberships  IslandMember[]
  notifications      Notification[]
  coinTransactions   CoinTransaction[]
  creatorApplication CreatorApplication?
  postLikes          PostLike[]
  postCollects       PostCollect[]
  commentLikes       CommentLike[]
  pageViews          PageView[]
  clickEvents        ClickEvent[]
  behaviors          UserBehavior[]

  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@map("user")
}

enum UserRole {
  user
  creator
  admin
}

enum UserStatus {
  active
  banned
  deleted
}

model Island {
  id          BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  name        String      @db.VarChar(100)
  description String?     @db.Text
  cover       String?    @db.VarChar(500)
  avatar      String?     @db.VarChar(500)
  category    String      @db.VarChar(50)
  ownerId     BigInt      @map("owner_id") @db.UnsignedBigInt
  price       Decimal     @default(0) @db.Decimal(10, 2)
  memberCount Int         @default(0) @map("member_count") @db.UnsignedInt
  postCount   Int         @default(0) @map("post_count") @db.UnsignedInt
  status      IslandStatus @default(pending)
  isVerified  Boolean     @default(false) @map("is_verified")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // 关联关系
  owner   User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  posts   Post[]
  members IslandMember[]

  @@index([ownerId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("island")
}

enum IslandStatus {
  pending
  active
  banned
  deleted
}

model Post {
  id           BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt      @map("user_id") @db.UnsignedBigInt
  islandId     BigInt?     @map("island_id") @db.UnsignedBigInt
  title        String?     @db.VarChar(200)
  content      String?     @db.Text
  mediaType    PostMediaType @default(text) @map("media_type")
  mediaUrls    Json?        @map("media_urls")
  likeCount    Int         @default(0) @map("like_count") @db.UnsignedInt
  commentCount Int         @default(0) @map("comment_count") @db.UnsignedInt
  collectCount Int         @default(0) @map("collect_count") @db.UnsignedInt
  viewCount    Int         @default(0) @map("view_count") @db.UnsignedInt
  shareCount   Int         @default(0) @map("share_count") @db.UnsignedInt
  status       PostStatus  @default(active)
  isTop        Boolean     @default(false) @map("is_top")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // 关联关系
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  island    Island?      @relation(fields: [islandId], references: [id], onDelete: SetNull)
  comments  Comment[]
  likes     PostLike[]
  collects  PostCollect[]

  @@index([userId])
  @@index([islandId])
  @@index([status])
  @@index([createdAt])
  @@index([mediaType])
  @@map("post")
}

enum PostMediaType {
  text
  image
  video
  mixed
}

enum PostStatus {
  active
  pending
  banned
  deleted
}

model Comment {
  id        BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  postId    BigInt       @map("post_id") @db.UnsignedBigInt
  userId    BigInt       @map("user_id") @db.UnsignedBigInt
  content   String       @db.Text
  parentId  BigInt?      @map("parent_id") @db.UnsignedBigInt
  likeCount Int          @default(0) @map("like_count") @db.UnsignedInt
  status    CommentStatus @default(active)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // 关联关系
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?     @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]    @relation("CommentReplies")
  likes     CommentLike[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comment")
}

enum CommentStatus {
  active
  banned
  deleted
}

model Follow {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  followerId  BigInt   @map("follower_id") @db.UnsignedBigInt
  followingId BigInt   @map("following_id") @db.UnsignedBigInt
  createdAt   DateTime @default(now()) @map("created_at")

  // 关联关系
  follower  User   @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follow")
}

model IslandMember {
  id         BigInt        @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt        @map("user_id") @db.UnsignedBigInt
  islandId   BigInt        @map("island_id") @db.UnsignedBigInt
  joinType   IslandJoinType @default(free) @map("join_type")
  paidAmount Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  // 关联关系
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  island Island @relation(fields: [islandId], references: [id], onDelete: Cascade)

  @@unique([userId, islandId])
  @@index([userId])
  @@index([islandId])
  @@index([createdAt])
  @@map("island_member")
}

enum IslandJoinType {
  free
  paid
}

model Notification {
  id         BigInt            @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt            @map("user_id") @db.UnsignedBigInt
  type       NotificationType
  title      String            @db.VarChar(200)
  content    String?           @db.Text
  relatedId  BigInt?           @map("related_id") @db.UnsignedBigInt
  relatedType String?          @map("related_type") @db.VarChar(50)
  isRead     Boolean           @default(false) @map("is_read")
  createdAt  DateTime          @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notification")
}

enum NotificationType {
  system
  interaction
  payment
}

model CoinTransaction {
  id          BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId      BigInt              @map("user_id") @db.UnsignedBigInt
  type        CoinTransactionType
  amount      Decimal             @db.Decimal(10, 2)
  balance     Decimal             @db.Decimal(10, 2)
  description String?             @db.VarChar(500)
  relatedId   BigInt?             @map("related_id") @db.UnsignedBigInt
  relatedType String?             @map("related_type") @db.VarChar(50)
  createdAt   DateTime            @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("coin_transaction")
}

enum CoinTransactionType {
  recharge
  consume
  reward
  refund
}

model PageView {
  id           BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt?   @map("user_id") @db.UnsignedBigInt
  pagePath     String    @map("page_path") @db.VarChar(500)
  pageTitle    String?   @map("page_title") @db.VarChar(200)
  deviceType   String?   @map("device_type") @db.VarChar(50)
  platform     String?   @db.VarChar(50)
  referrer     String?   @db.VarChar(500)
  stayDuration Int?      @map("stay_duration") @db.UnsignedInt
  ipAddress    String?   @map("ip_address") @db.VarChar(50)
  userAgent    String?   @map("user_agent") @db.VarChar(500)
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([pagePath])
  @@index([createdAt])
  @@index([platform])
  @@map("page_view")
}

model ClickEvent {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt?   @map("user_id") @db.UnsignedBigInt
  eventType       String   @map("event_type") @db.VarChar(50)
  elementId       String?  @map("element_id") @db.VarChar(200)
  elementType     String?  @map("element_type") @db.VarChar(50)
  pagePath        String   @map("page_path") @db.VarChar(500)
  clickPositionX  Int?     @map("click_position_x") @db.UnsignedInt
  clickPositionY  Int?     @map("click_position_y") @db.UnsignedInt
  relatedId       BigInt?  @map("related_id") @db.UnsignedBigInt
  relatedType     String?  @map("related_type") @db.VarChar(50)
  ipAddress       String?  @map("ip_address") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([pagePath])
  @@index([createdAt])
  @@map("click_event")
}

model UserBehavior {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt?  @map("user_id") @db.UnsignedBigInt
  behaviorType String   @map("behavior_type") @db.VarChar(50)
  targetType   String   @map("target_type") @db.VarChar(50)
  targetId     BigInt   @map("target_id") @db.UnsignedBigInt
  pagePath     String?  @map("page_path") @db.VarChar(500)
  deviceInfo   Json?    @map("device_info")
  ipAddress    String?  @map("ip_address") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([behaviorType])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("user_behavior")
}

model CreatorApplication {
  id              BigInt                    @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt                     @map("user_id") @db.UnsignedBigInt
  realName        String?                    @map("real_name") @db.VarChar(50)
  idCard          String?                    @map("id_card") @db.VarChar(50)
  phone           String?                    @db.VarChar(20)
  email           String?                    @db.VarChar(100)
  bio             String?                    @db.Text
  qualificationUrls Json?                   @map("qualification_urls")
  status          CreatorApplicationStatus   @default(pending)
  rejectReason    String?                    @map("reject_reason") @db.Text
  reviewedBy      BigInt?                    @map("reviewed_by") @db.UnsignedBigInt
  reviewedAt      DateTime?                  @map("reviewed_at")
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")

  // 关联关系
  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer   User? @relation("CreatorApplicationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("creator_application")
}

enum CreatorApplicationStatus {
  pending
  approved
  rejected
}

model PostLike {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  postId    BigInt   @map("post_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_like")
}

model PostCollect {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  postId    BigInt   @map("post_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_collect")
}

model CommentLike {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  commentId BigInt   @map("comment_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_like")
}
```

## 五、数据库初始化说明

### 5.1 环境变量配置

在 `.env` 文件中配置数据库连接：

```env
DATABASE_URL="mysql://root:123456@0.tcp.jp.ngrok.io:10625/island_social?schema=public"
```

### 5.2 Prisma 初始化步骤

1. **安装 Prisma CLI**
```bash
npm install -D prisma
npm install @prisma/client
```

2. **初始化 Prisma**
```bash
npx prisma init
```

3. **创建迁移文件**
```bash
npx prisma migrate dev --name init
```

4. **生成 Prisma Client**
```bash
npx prisma generate
```

5. **查看数据库（可选）**
```bash
npx prisma studio
```

### 5.3 测试数据准备

建议创建种子文件 `prisma/seed.ts` 用于初始化测试数据：

- 创建10个普通用户
- 创建5个创作者用户
- 创建3个岛屿创建者
- 创建10个不同分类的岛屿
- 创建50条各类帖子
- 创建200条评论
- 创建50条关注关系
- 创建100条岛屿帖子

## 六、数据表关系说明

### 6.1 用户相关关系

- **User → Post**: 一对多，一个用户可发布多条帖子
- **User → Comment**: 一对多，一个用户可发表多条评论
- **User → Follow**: 多对多（通过 Follow 表），用户之间可互相关注
- **User → Island**: 一对多，一个用户可创建多个岛屿
- **User → IslandMember**: 多对多（通过 IslandMember 表），用户可加入多个岛屿

### 6.2 内容相关关系

- **Post → Comment**: 一对多，一个帖子可有多个评论
- **Post → PostLike**: 多对多（通过 PostLike 表），帖子可被多个用户点赞
- **Post → PostCollect**: 多对多（通过 PostCollect 表），帖子可被多个用户收藏
- **Comment → CommentLike**: 多对多（通过 CommentLike 表），评论可被多个用户点赞
- **Comment → Comment**: 自关联，支持评论回复（通过 parent_id）

### 6.3 岛屿相关关系

- **Island → Post**: 一对多，一个岛屿可包含多条帖子
- **Island → IslandMember**: 一对多，一个岛屿可有多个成员

### 6.4 统计相关关系

- **User → PageView**: 一对多，一个用户可有多次页面访问记录
- **User → ClickEvent**: 一对多，一个用户可有多次点击事件
- **User → UserBehavior**: 一对多，一个用户可有多个行为记录

## 七、索引优化建议

1. **高频查询字段**：为经常用于 WHERE、JOIN、ORDER BY 的字段创建索引
2. **复合索引**：为经常组合查询的字段创建复合索引（如 user_id + created_at）
3. **唯一索引**：确保唯一性约束的字段（如 username、phone、email）
4. **外键索引**：所有外键字段自动创建索引

## 八、数据完整性约束

1. **外键约束**：使用 ON DELETE CASCADE 或 ON DELETE SET NULL 确保数据一致性
2. **唯一约束**：防止重复数据（如用户不能重复关注同一人、不能重复点赞同一帖子）
3. **非空约束**：关键字段设置为 NOT NULL
4. **枚举约束**：使用 ENUM 类型限制字段取值范围

## 九、版本历史

- **v1.0** (2025-01-XX): 初始数据库设计
  - 创建15个核心数据表
  - 定义完整的字段和索引
  - 设计 Prisma Schema

---

**文档版本：** v1.0  
**创建日期：** 2025年1月  
**最后更新：** 2025年1月

