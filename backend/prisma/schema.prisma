// Prisma Schema 文件：backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id              BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  username        String    @unique @db.VarChar(50)
  nickname        String    @db.VarChar(50)
  avatar          String?   @db.VarChar(500)
  phone           String?   @unique @db.VarChar(20)
  email           String?   @unique @db.VarChar(100)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  bio             String?   @db.Text
  backgroundImage String?   @map("background_image") @db.VarChar(500)
  gender          Int?      @default(0) @db.TinyInt
  birthday        DateTime? @db.Date
  role            UserRole  @default(user)
  status          UserStatus @default(active)
  isVerified      Boolean   @default(false) @map("is_verified")
  coinBalance     Decimal   @default(0) @map("coin_balance") @db.Decimal(10, 2)
  followCount     Int       @default(0) @map("follow_count") @db.UnsignedInt
  followerCount   Int       @default(0) @map("follower_count") @db.UnsignedInt
  postCount       Int       @default(0) @map("post_count") @db.UnsignedInt
  likeCount       Int       @default(0) @map("like_count") @db.UnsignedInt
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // 关联关系
  posts              Post[]
  comments           Comment[]
  following          Follow[] @relation("Follower")
  followers          Follow[] @relation("Following")
  ownedIslands       Island[]
  islandMemberships  IslandMember[]
  notifications      Notification[]
  coinTransactions   CoinTransaction[]
  creatorApplication CreatorApplication?
  postLikes          PostLike[]
  postCollects       PostCollect[]
  commentLikes       CommentLike[]
  pageViews          PageView[]
  clickEvents        ClickEvent[]
  behaviors          UserBehavior[]
  reviewedApplications CreatorApplication[] @relation("CreatorApplicationReviewer")

  @@index([status])
  @@index([role])
  @@index([createdAt])
  @@map("user")
}

enum UserRole {
  user
  creator
  admin
}

enum UserStatus {
  active
  banned
  deleted
}

model Island {
  id          BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  name        String      @db.VarChar(100)
  description String?     @db.Text
  cover       String?    @db.VarChar(500)
  avatar      String?     @db.VarChar(500)
  category    String      @db.VarChar(50)
  ownerId     BigInt      @map("owner_id") @db.UnsignedBigInt
  price       Decimal     @default(0) @db.Decimal(10, 2)
  memberCount Int         @default(0) @map("member_count") @db.UnsignedInt
  postCount   Int         @default(0) @map("post_count") @db.UnsignedInt
  status      IslandStatus @default(pending)
  isVerified  Boolean     @default(false) @map("is_verified")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // 关联关系
  owner   User          @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  posts   Post[]
  members IslandMember[]

  @@index([ownerId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
  @@map("island")
}

enum IslandStatus {
  pending
  active
  banned
  deleted
}

model Post {
  id           BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt      @map("user_id") @db.UnsignedBigInt
  islandId     BigInt?     @map("island_id") @db.UnsignedBigInt
  title        String?     @db.VarChar(200)
  content      String?     @db.Text
  mediaType    PostMediaType @default(text) @map("media_type")
  mediaUrls    Json?        @map("media_urls")
  likeCount    Int         @default(0) @map("like_count") @db.UnsignedInt
  commentCount Int         @default(0) @map("comment_count") @db.UnsignedInt
  collectCount Int         @default(0) @map("collect_count") @db.UnsignedInt
  viewCount    Int         @default(0) @map("view_count") @db.UnsignedInt
  shareCount   Int         @default(0) @map("share_count") @db.UnsignedInt
  status       PostStatus  @default(active)
  isTop        Boolean     @default(false) @map("is_top")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  // 关联关系
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  island    Island?      @relation(fields: [islandId], references: [id], onDelete: SetNull)
  comments  Comment[]
  likes     PostLike[]
  collects  PostCollect[]

  @@index([userId])
  @@index([islandId])
  @@index([status])
  @@index([createdAt])
  @@index([mediaType])
  @@map("post")
}

enum PostMediaType {
  text
  image
  video
  mixed
}

enum PostStatus {
  active
  pending
  banned
  deleted
}

model Comment {
  id        BigInt       @id @default(autoincrement()) @db.UnsignedBigInt
  postId    BigInt       @map("post_id") @db.UnsignedBigInt
  userId    BigInt       @map("user_id") @db.UnsignedBigInt
  content   String       @db.Text
  parentId  BigInt?      @map("parent_id") @db.UnsignedBigInt
  likeCount Int          @default(0) @map("like_count") @db.UnsignedInt
  status    CommentStatus @default(active)
  createdAt DateTime     @default(now()) @map("created_at")
  updatedAt DateTime     @updatedAt @map("updated_at")

  // 关联关系
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment?     @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[]    @relation("CommentReplies")
  likes     CommentLike[]

  @@index([postId])
  @@index([userId])
  @@index([parentId])
  @@index([createdAt])
  @@map("comment")
}

enum CommentStatus {
  active
  banned
  deleted
}

model Follow {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  followerId  BigInt   @map("follower_id") @db.UnsignedBigInt
  followingId BigInt   @map("following_id") @db.UnsignedBigInt
  createdAt   DateTime @default(now()) @map("created_at")

  // 关联关系
  follower  User   @relation("Follower", fields: [followerId], references: [id], onDelete: Cascade)
  following User   @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follow")
}

model IslandMember {
  id         BigInt        @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt        @map("user_id") @db.UnsignedBigInt
  islandId   BigInt        @map("island_id") @db.UnsignedBigInt
  joinType   IslandJoinType @default(free) @map("join_type")
  paidAmount Decimal       @default(0) @map("paid_amount") @db.Decimal(10, 2)
  createdAt  DateTime      @default(now()) @map("created_at")
  updatedAt  DateTime      @updatedAt @map("updated_at")

  // 关联关系
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  island Island @relation(fields: [islandId], references: [id], onDelete: Cascade)

  @@unique([userId, islandId])
  @@index([userId])
  @@index([islandId])
  @@index([createdAt])
  @@map("island_member")
}

enum IslandJoinType {
  free
  paid
}

model Notification {
  id         BigInt            @id @default(autoincrement()) @db.UnsignedBigInt
  userId     BigInt            @map("user_id") @db.UnsignedBigInt
  type       NotificationType
  title      String            @db.VarChar(200)
  content    String?           @db.Text
  relatedId  BigInt?           @map("related_id") @db.UnsignedBigInt
  relatedType String?          @map("related_type") @db.VarChar(50)
  isRead     Boolean           @default(false) @map("is_read")
  createdAt  DateTime          @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
  @@map("notification")
}

enum NotificationType {
  system
  interaction
  payment
}

model CoinTransaction {
  id          BigInt              @id @default(autoincrement()) @db.UnsignedBigInt
  userId      BigInt              @map("user_id") @db.UnsignedBigInt
  type        CoinTransactionType
  amount      Decimal             @db.Decimal(10, 2)
  balance     Decimal             @db.Decimal(10, 2)
  description String?             @db.VarChar(500)
  relatedId   BigInt?             @map("related_id") @db.UnsignedBigInt
  relatedType String?             @map("related_type") @db.VarChar(50)
  createdAt   DateTime            @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([createdAt])
  @@map("coin_transaction")
}

enum CoinTransactionType {
  recharge
  consume
  reward
  refund
}

model PageView {
  id           BigInt    @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt?   @map("user_id") @db.UnsignedBigInt
  pagePath     String    @map("page_path") @db.VarChar(500)
  pageTitle    String?   @map("page_title") @db.VarChar(200)
  deviceType   String?   @map("device_type") @db.VarChar(50)
  platform     String?   @db.VarChar(50)
  referrer     String?   @db.VarChar(500)
  stayDuration Int?      @map("stay_duration") @db.UnsignedInt
  ipAddress    String?   @map("ip_address") @db.VarChar(50)
  userAgent    String?   @map("user_agent") @db.VarChar(500)
  createdAt    DateTime  @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([pagePath])
  @@index([createdAt])
  @@index([platform])
  @@map("page_view")
}

model ClickEvent {
  id              BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt?   @map("user_id") @db.UnsignedBigInt
  eventType       String   @map("event_type") @db.VarChar(50)
  elementId       String?  @map("element_id") @db.VarChar(200)
  elementType     String?  @map("element_type") @db.VarChar(50)
  pagePath        String   @map("page_path") @db.VarChar(500)
  clickPositionX  Int?     @map("click_position_x") @db.UnsignedInt
  clickPositionY  Int?     @map("click_position_y") @db.UnsignedInt
  relatedId       BigInt?  @map("related_id") @db.UnsignedBigInt
  relatedType     String?  @map("related_type") @db.VarChar(50)
  ipAddress       String?  @map("ip_address") @db.VarChar(50)
  createdAt       DateTime @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventType])
  @@index([pagePath])
  @@index([createdAt])
  @@map("click_event")
}

model UserBehavior {
  id           BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId       BigInt?  @map("user_id") @db.UnsignedBigInt
  behaviorType String   @map("behavior_type") @db.VarChar(50)
  targetType   String   @map("target_type") @db.VarChar(50)
  targetId     BigInt   @map("target_id") @db.UnsignedBigInt
  pagePath     String?  @map("page_path") @db.VarChar(500)
  deviceInfo   Json?    @map("device_info")
  ipAddress    String?  @map("ip_address") @db.VarChar(50)
  createdAt    DateTime @default(now()) @map("created_at")

  // 关联关系
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([behaviorType])
  @@index([targetType, targetId])
  @@index([createdAt])
  @@map("user_behavior")
}

model CreatorApplication {
  id              BigInt                    @id @default(autoincrement()) @db.UnsignedBigInt
  userId          BigInt                     @map("user_id") @db.UnsignedBigInt
  realName        String?                    @map("real_name") @db.VarChar(50)
  idCard          String?                    @map("id_card") @db.VarChar(50)
  phone           String?                    @db.VarChar(20)
  email           String?                    @db.VarChar(100)
  bio             String?                    @db.Text
  qualificationUrls Json?                   @map("qualification_urls")
  status          CreatorApplicationStatus   @default(pending)
  rejectReason    String?                    @map("reject_reason") @db.Text
  reviewedBy      BigInt?                    @map("reviewed_by") @db.UnsignedBigInt
  reviewedAt      DateTime?                  @map("reviewed_at")
  createdAt       DateTime                   @default(now()) @map("created_at")
  updatedAt       DateTime                   @updatedAt @map("updated_at")

  // 关联关系
  user       User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewer   User? @relation("CreatorApplicationReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("creator_application")
}

enum CreatorApplicationStatus {
  pending
  approved
  rejected
}

model PostLike {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  postId    BigInt   @map("post_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_like")
}

model PostCollect {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  postId    BigInt   @map("post_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
  @@map("post_collect")
}

model CommentLike {
  id        BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  userId    BigInt   @map("user_id") @db.UnsignedBigInt
  commentId BigInt   @map("comment_id") @db.UnsignedBigInt
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@index([userId])
  @@index([commentId])
  @@map("comment_like")
}

