# 数据库修复说明

## 问题描述

1. **P2021 错误**：表 'post' 不存在
   - 原因：数据库迁移未在服务器上执行
   - 位置：`/home/objct_b/nuxtjs/logs/err.log`

2. **Prisma Studio 错误**：Prisma Client 构建问题
   - 原因：Prisma Client 未正确生成或版本不匹配

## 解决方案

### 方法一：使用 npm 脚本（推荐）

在服务器上执行以下命令：

```bash
cd /home/objct_b/nuxtjs
npm run db:fix
```

这个命令会：
1. 重新生成 Prisma Client
2. 执行数据库迁移

### 方法二：手动执行

如果方法一不行，可以手动执行：

```bash
cd /home/objct_b/nuxtjs

# 1. 重新生成 Prisma Client
npx prisma generate

# 2. 执行数据库迁移（生产环境）
npx prisma migrate deploy

# 或者使用 db push（会直接同步 schema，不记录迁移历史）
npx prisma db push
```

### 方法三：使用修复脚本

**Linux/Mac:**
```bash
cd /home/objct_b/nuxtjs
chmod +x scripts/fix-db.sh
./scripts/fix-db.sh
```

**Windows:**
```powershell
cd E:\work\objct_b\nuxtjs
.\scripts\fix-db.ps1
```

## 环境变量检查

确保服务器上的环境变量 `DATABASE_URL` 已正确设置：

```bash
# 检查环境变量
echo $DATABASE_URL

# 格式应该是：
# mysql://用户名:密码@主机:端口/数据库名
# 例如：mysql://root:123456@8.217.182.192:3306/数据库名
```

如果未设置，需要：
1. 创建或编辑 `.env` 文件
2. 添加 `DATABASE_URL` 配置

## 验证修复

修复后，验证步骤：

1. **检查表是否存在**：
```bash
npx prisma studio
```

2. **检查 PM2 日志**：
```bash
pm2 logs nuxtjs-a --lines 50
```

3. **重启服务**（如果需要）：
```bash
pm2 restart nuxtjs-a
```

## 常见问题

### Q: 迁移失败，提示表已存在
A: 使用 `prisma db push` 而不是 `prisma migrate deploy`

### Q: Prisma Client 生成失败
A: 删除 `node_modules/.prisma` 目录后重新生成：
```bash
rm -rf node_modules/.prisma
npm run db:generate
```

### Q: 数据库连接失败
A: 检查：
- 数据库服务是否运行
- 网络连接是否正常
- 用户名密码是否正确
- 防火墙是否允许连接

