# MySQL 数据库初始化指南

## 一、安装 MySQL

### Ubuntu/Debian 系统

```bash
# 更新包列表
sudo apt update

# 安装 MySQL 服务器
sudo apt install mysql-server -y

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql
```

### CentOS/RHEL 系统

```bash
# 安装 MySQL 仓库
sudo yum install mysql-server -y

# 启动 MySQL 服务
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

## 二、初始化数据库并设置密码

### 方法1：使用 mysql_secure_installation（推荐）

```bash
# 运行安全配置脚本
sudo mysql_secure_installation
```

按提示操作：
1. 设置验证密码插件：选择 `n`（不使用）
2. 设置 root 密码：输入 `123456`
3. 确认密码：再次输入 `123456`
4. 移除匿名用户：选择 `y`
5. 禁止 root 远程登录：选择 `n`（允许远程登录）
6. 移除测试数据库：选择 `y`
7. 重新加载权限表：选择 `y`

### 方法2：手动设置密码

```bash
# 登录 MySQL（首次安装可能无需密码）
sudo mysql

# 在 MySQL 命令行中执行
ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY '123456';
FLUSH PRIVILEGES;
EXIT;
```

## 三、配置远程连接

### 1. 修改 MySQL 配置文件

```bash
# 编辑 MySQL 配置文件
sudo nano /etc/mysql/mysql.conf.d/mysqld.cnf
# 或
sudo nano /etc/my.cnf
```

找到 `bind-address` 配置项，修改为：

```ini
bind-address = 0.0.0.0
```

如果找不到，在 `[mysqld]` 部分添加：

```ini
[mysqld]
bind-address = 0.0.0.0
```

### 2. 创建远程访问用户（推荐）

```bash
# 登录 MySQL
mysql -u root -p
# 输入密码：123456
```

在 MySQL 命令行中执行：

```sql
-- 创建远程访问用户（如果使用 root，可跳过此步）
CREATE USER 'root'@'%' IDENTIFIED BY '123456';

-- 授予所有权限
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' WITH GRANT OPTION;

-- 刷新权限
FLUSH PRIVILEGES;

-- 查看用户权限
SELECT user, host FROM mysql.user;

-- 退出
EXIT;
```

### 3. 如果 root 用户已存在，直接授权

```sql
-- 允许 root 从任何主机连接
GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '123456' WITH GRANT OPTION;
FLUSH PRIVILEGES;
```

## 四、重启 MySQL 服务

```bash
# 重启 MySQL
sudo systemctl restart mysql
# 或
sudo systemctl restart mysqld

# 检查服务状态
sudo systemctl status mysql
```

## 五、配置防火墙

### Ubuntu/Debian (UFW)

```bash
# 允许 MySQL 端口（3306）
sudo ufw allow 3306/tcp
sudo ufw reload
```

### CentOS/RHEL (firewalld)

```bash
# 允许 MySQL 端口
sudo firewall-cmd --permanent --add-service=mysql
sudo firewall-cmd --reload
```

### 云服务器安全组

在云服务器控制台（阿里云、腾讯云等）配置安全组规则：
- 端口：3306
- 协议：TCP
- 授权对象：0.0.0.0/0（或指定IP）

## 六、创建项目数据库

```bash
# 登录 MySQL
mysql -u root -p
# 输入密码：123456
```

```sql
-- 创建数据库
CREATE DATABASE IF NOT EXISTS objct_b CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 查看数据库
SHOW DATABASES;

-- 退出
EXIT;
```

## 七、配置项目环境变量

在项目根目录创建 `.env` 文件：

```bash
cd nuxtjs
nano .env
```

添加以下内容：

```env
# 数据库配置
DATABASE_URL="mysql://root:123456@8.217.182.192:3306/objct_b?charset=utf8mb4&connection_limit=10"

# 或使用环境变量方式
DB_HOST=8.217.182.192
DB_PORT=3306
DB_USER=root
DB_PASSWORD=123456
DB_NAME=objct_b
```

如果使用环境变量方式，需要修改 `prisma/schema.prisma` 中的 `DATABASE_URL` 为：

```prisma
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}
```

并在代码中动态构建：

```typescript
// 在 nuxt.config.ts 或环境配置中
const databaseUrl = process.env.DATABASE_URL || 
  `mysql://${process.env.DB_USER}:${process.env.DB_PASSWORD}@${process.env.DB_HOST}:${process.env.DB_PORT}/${process.env.DB_NAME}?charset=utf8mb4`
```

## 八、运行数据库迁移

```bash
cd nuxtjs

# 生成 Prisma Client
npm run db:generate

# 运行数据库迁移
npm run db:migrate

# 或直接推送 schema（开发环境）
npm run db:push

# 填充测试数据（可选）
npm run db:seed
```

## 九、测试数据库连接

```bash
# 使用项目脚本测试
npm run db:test

# 或手动测试
mysql -h 8.217.182.192 -u root -p
# 输入密码：123456
```

## 十、常见问题排查

### 1. 无法远程连接

```bash
# 检查 MySQL 是否监听所有接口
sudo netstat -tlnp | grep 3306
# 应该显示 0.0.0.0:3306

# 检查用户权限
mysql -u root -p -e "SELECT user, host FROM mysql.user;"
```

### 2. 忘记 root 密码

```bash
# 停止 MySQL
sudo systemctl stop mysql

# 以安全模式启动
sudo mysqld_safe --skip-grant-tables &

# 登录（无需密码）
mysql -u root

# 重置密码
USE mysql;
UPDATE user SET authentication_string=PASSWORD('123456') WHERE User='root';
FLUSH PRIVILEGES;
EXIT;

# 重启 MySQL
sudo systemctl restart mysql
```

### 3. 连接被拒绝

- 检查防火墙规则
- 检查安全组配置
- 检查 MySQL 配置文件中的 bind-address
- 检查用户权限（host 是否为 %）

### 4. 字符集问题

确保数据库使用 utf8mb4：

```sql
-- 修改数据库字符集
ALTER DATABASE objct_b CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

## 十一、安全建议

1. **不要使用 root 用户远程连接**（生产环境）
   - 创建专用数据库用户
   - 只授予必要的权限

2. **使用强密码**
   - 密码长度至少 12 位
   - 包含大小写字母、数字、特殊字符

3. **限制访问 IP**
   - 在安全组中只允许特定 IP 访问
   - 使用 VPN 或跳板机

4. **启用 SSL 连接**
   - 配置 MySQL SSL 证书
   - 在连接字符串中添加 SSL 参数

5. **定期备份**
   ```bash
   # 备份数据库
   mysqldump -u root -p objct_b > backup_$(date +%Y%m%d).sql
   ```

## 十二、快速初始化脚本

创建 `init-db.sh` 脚本：

```bash
#!/bin/bash

# 设置 MySQL root 密码
MYSQL_ROOT_PASSWORD="123456"
DB_NAME="objct_b"
DB_USER="root"
DB_HOST="8.217.182.192"

# 登录 MySQL 并执行初始化
mysql -u root -p${MYSQL_ROOT_PASSWORD} <<EOF
-- 创建数据库
CREATE DATABASE IF NOT EXISTS ${DB_NAME} CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 授权（如果使用 root）
GRANT ALL PRIVILEGES ON ${DB_NAME}.* TO '${DB_USER}'@'%' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}';
FLUSH PRIVILEGES;

-- 显示数据库
SHOW DATABASES;
EOF

echo "数据库初始化完成！"
```

运行脚本：

```bash
chmod +x init-db.sh
./init-db.sh
```

