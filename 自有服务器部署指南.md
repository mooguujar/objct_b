# è‡ªæœ‰æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ğŸ“¦ ä¸€ã€æœ¬åœ°æ„å»ºæ‰“åŒ…

### 1. å®‰è£…ä¾èµ–å¹¶æ„å»º

```bash
cd nuxtjs

# å®‰è£…ä¾èµ–
npm install

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬ï¼ˆä¼šç”Ÿæˆ .output ç›®å½•ï¼‰
npm run build
```

### 2. æ„å»ºåçš„æ–‡ä»¶ç»“æ„

æ„å»ºå®Œæˆåï¼Œä¼šç”Ÿæˆ `.output` ç›®å½•ï¼Œç»“æ„å¦‚ä¸‹ï¼š

```
.output/
â”œâ”€â”€ server/          # æœåŠ¡ç«¯ä»£ç ï¼ˆåŒ…å« APIï¼‰
â”‚   â”œâ”€â”€ index.mjs    # æœåŠ¡ç«¯å…¥å£æ–‡ä»¶
â”‚   â””â”€â”€ ...
â”œâ”€â”€ public/          # é™æ€èµ„æº
â””â”€â”€ nitro.json       # Nitro é…ç½®
```

### 3. éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶

**å¿…é¡»ä¸Šä¼ ï¼š**
- `.output/` ç›®å½•ï¼ˆæ•´ä¸ªç›®å½•ï¼‰
- `node_modules/` ç›®å½•ï¼ˆç”Ÿäº§ä¾èµ–ï¼‰
- `package.json`
- `package-lock.json` æˆ– `yarn.lock`
- `.env` æ–‡ä»¶ï¼ˆç¯å¢ƒå˜é‡é…ç½®ï¼‰
- `prisma/` ç›®å½•ï¼ˆæ•°æ®åº“ schema å’Œè¿ç§»æ–‡ä»¶ï¼‰

**å¯é€‰ä¸Šä¼ ï¼š**
- `prisma/migrations/`ï¼ˆå¦‚æœä½¿ç”¨è¿ç§»ï¼‰

## ğŸš€ äºŒã€æœåŠ¡å™¨ç¯å¢ƒå‡†å¤‡

### 1. å®‰è£… Node.js

```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# éªŒè¯å®‰è£…
node --version
npm --version
```

### 2. å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†ï¼‰

```bash
npm install -g pm2
```

### 3. å®‰è£… Nginxï¼ˆåå‘ä»£ç†ï¼Œå¯é€‰ä½†æ¨èï¼‰

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install nginx

# CentOS/RHEL
sudo yum install nginx
```

## ğŸ“¤ ä¸‰ã€ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨

### æ–¹æ³• 1: ä½¿ç”¨ SCP

```bash
# åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•æ‰§è¡Œ
cd nuxtjs

# æ‰“åŒ…éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶
tar -czf nuxtjs-deploy.tar.gz \
  .output \
  node_modules \
  package.json \
  package-lock.json \
  .env \
  prisma

# ä¸Šä¼ åˆ°æœåŠ¡å™¨
scp nuxtjs-deploy.tar.gz user@your-server:/path/to/deploy/

# åœ¨æœåŠ¡å™¨ä¸Šè§£å‹
ssh user@your-server
cd /path/to/deploy
tar -xzf nuxtjs-deploy.tar.gz
```

### æ–¹æ³• 2: ä½¿ç”¨ Gitï¼ˆæ¨èï¼‰

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
git clone your-repo-url
cd nuxtjs
npm install --production
npm run build
```

### æ–¹æ³• 3: ä½¿ç”¨ rsync

```bash
rsync -avz --exclude 'node_modules' \
  --exclude '.nuxt' \
  --exclude '.output' \
  ./ user@your-server:/path/to/deploy/

# åœ¨æœåŠ¡å™¨ä¸Šå®‰è£…ä¾èµ–å¹¶æ„å»º
ssh user@your-server
cd /path/to/deploy/nuxtjs
npm install --production
npm run build
```

## âš™ï¸ å››ã€æœåŠ¡å™¨é…ç½®

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /path/to/deploy/nuxtjs
nano .env
```

```env
# æ•°æ®åº“é…ç½®
DB_HOST=your-db-host
DB_PORT=3306
DB_USER=your-db-user
DB_PASSWORD=your-db-password
DATABASE_URL=mysql://user:password@host:port/database

# OSS é…ç½®
OSS_BUCKET=your-bucket
OSS_ENDPOINT=oss-cn-hongkong.aliyuncs.com
OSS_REGION=oss-cn-hongkong
OSS_ACCESS_KEY=your-access-key
OSS_ACCESS_SECRET=your-access-secret

# JWT é…ç½®
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# Node ç¯å¢ƒ
NODE_ENV=production
PORT=3000
```

### 2. æ•°æ®åº“è¿ç§»

```bash
cd /path/to/deploy/nuxtjs

# è¿è¡Œ Prisma è¿ç§»
npx prisma migrate deploy

# æˆ–ç”Ÿæˆ Prisma Client
npx prisma generate
```

## ğŸ¯ äº”ã€å¯åŠ¨æœåŠ¡

### æ–¹æ³• 1: ä½¿ç”¨ PM2ï¼ˆæ¨èï¼‰

#### åˆ›å»º PM2 é…ç½®æ–‡ä»¶

åˆ›å»º `ecosystem.config.js`ï¼š

```javascript
module.exports = {
  apps: [{
    name: 'nuxtjs-app',
    script: '.output/server/index.mjs',
    instances: 2, // æˆ– 'max' ä½¿ç”¨æ‰€æœ‰ CPU æ ¸å¿ƒ
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    merge_logs: true,
    autorestart: true,
    watch: false,
    max_memory_restart: '1G'
  }]
}
```

#### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs nuxtjs-app

# é‡å¯
pm2 restart nuxtjs-app

# åœæ­¢
pm2 stop nuxtjs-app

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

### æ–¹æ³• 2: ç›´æ¥ä½¿ç”¨ Node.js

```bash
# å¯åŠ¨
node .output/server/index.mjs

# æˆ–ä½¿ç”¨ nohup åå°è¿è¡Œ
nohup node .output/server/index.mjs > app.log 2>&1 &
```

### æ–¹æ³• 3: ä½¿ç”¨ systemdï¼ˆLinuxï¼‰

åˆ›å»ºæœåŠ¡æ–‡ä»¶ `/etc/systemd/system/nuxtjs.service`ï¼š

```ini
[Unit]
Description=Nuxt.js Application
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/deploy/nuxtjs
Environment=NODE_ENV=production
Environment=PORT=3000
ExecStart=/usr/bin/node .output/server/index.mjs
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

å¯åŠ¨æœåŠ¡ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable nuxtjs
sudo systemctl start nuxtjs
sudo systemctl status nuxtjs
```

## ğŸŒ å…­ã€é…ç½® Nginx åå‘ä»£ç†

åˆ›å»º Nginx é…ç½®æ–‡ä»¶ `/etc/nginx/sites-available/nuxtjs`ï¼š

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # é‡å®šå‘åˆ° HTTPSï¼ˆå¦‚æœæœ‰ SSL è¯ä¹¦ï¼‰
    # return 301 https://$server_name$request_uri;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

å¯ç”¨é…ç½®ï¼š

```bash
sudo ln -s /etc/nginx/sites-available/nuxtjs /etc/nginx/sites-enabled/
sudo nginx -t  # æµ‹è¯•é…ç½®
sudo systemctl reload nginx
```

## ğŸ”’ ä¸ƒã€é…ç½® SSL è¯ä¹¦ï¼ˆHTTPSï¼‰

### ä½¿ç”¨ Let's Encryptï¼ˆå…è´¹ï¼‰

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

## ğŸ“‹ å…«ã€å®Œæ•´éƒ¨ç½²è„šæœ¬

åˆ›å»º `deploy.sh`ï¼š

```bash
#!/bin/bash

# éƒ¨ç½²è„šæœ¬
PROJECT_DIR="/path/to/deploy/nuxtjs"
APP_NAME="nuxtjs-app"

echo "å¼€å§‹éƒ¨ç½²..."

cd $PROJECT_DIR

# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨ Gitï¼‰
# git pull origin main

# å®‰è£…ä¾èµ–
echo "å®‰è£…ä¾èµ–..."
npm install --production

# æ„å»ºé¡¹ç›®
echo "æ„å»ºé¡¹ç›®..."
npm run build

# æ•°æ®åº“è¿ç§»
echo "è¿è¡Œæ•°æ®åº“è¿ç§»..."
npx prisma migrate deploy
npx prisma generate

# é‡å¯ PM2
echo "é‡å¯åº”ç”¨..."
pm2 restart $APP_NAME

echo "éƒ¨ç½²å®Œæˆï¼"
```

ä½¿ç”¨ï¼š

```bash
chmod +x deploy.sh
./deploy.sh
```

## ğŸ” ä¹ã€ç›‘æ§å’Œæ—¥å¿—

### PM2 ç›‘æ§

```bash
# æŸ¥çœ‹å®æ—¶ç›‘æ§
pm2 monit

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show nuxtjs-app
```

### æ—¥å¿—ä½ç½®

- PM2 æ—¥å¿—ï¼š`~/.pm2/logs/`
- åº”ç”¨æ—¥å¿—ï¼šé¡¹ç›®ç›®å½•ä¸‹çš„ `logs/` ç›®å½•
- Nginx æ—¥å¿—ï¼š`/var/log/nginx/`

## âš ï¸ åã€å¸¸è§é—®é¢˜

### 1. ç«¯å£è¢«å ç”¨

```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo lsof -i :3000
# æˆ–
sudo netstat -tulpn | grep 3000

# æ€æ­»è¿›ç¨‹
sudo kill -9 PID
```

### 2. æƒé™é—®é¢˜

```bash
# ç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®
sudo chown -R www-data:www-data /path/to/deploy/nuxtjs
sudo chmod -R 755 /path/to/deploy/nuxtjs
```

### 3. å†…å­˜ä¸è¶³

```bash
# å¢åŠ  Node.js å†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=4096"
```

### 4. æ•°æ®åº“è¿æ¥å¤±è´¥

- æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å¯ä»¥ä»æœåŠ¡å™¨è®¿é—®
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™

## ğŸ“Š åä¸€ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **ä½¿ç”¨ PM2 Cluster æ¨¡å¼**ï¼šå……åˆ†åˆ©ç”¨å¤šæ ¸ CPU
2. **å¯ç”¨ Nginx ç¼“å­˜**ï¼šç¼“å­˜é™æ€èµ„æº
3. **ä½¿ç”¨ CDN**ï¼šåŠ é€Ÿé™æ€èµ„æºåŠ è½½
4. **æ•°æ®åº“è¿æ¥æ± **ï¼šä¼˜åŒ–æ•°æ®åº“è¿æ¥
5. **å¯ç”¨ Gzip å‹ç¼©**ï¼šåœ¨ Nginx ä¸­å¯ç”¨

## ğŸ¯ å¿«é€Ÿéƒ¨ç½²æ¸…å•

- [ ] æœåŠ¡å™¨å®‰è£… Node.js å’Œ npm
- [ ] å®‰è£… PM2
- [ ] å®‰è£… Nginxï¼ˆå¯é€‰ï¼‰
- [ ] ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
- [ ] é…ç½®ç¯å¢ƒå˜é‡ï¼ˆ.envï¼‰
- [ ] è¿è¡Œæ•°æ®åº“è¿ç§»
- [ ] æ„å»ºé¡¹ç›®ï¼ˆnpm run buildï¼‰
- [ ] å¯åŠ¨æœåŠ¡ï¼ˆPM2ï¼‰
- [ ] é…ç½® Nginx åå‘ä»£ç†
- [ ] é…ç½® SSL è¯ä¹¦ï¼ˆå¯é€‰ï¼‰
- [ ] è®¾ç½®é˜²ç«å¢™è§„åˆ™
- [ ] æµ‹è¯•è®¿é—®

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `ecosystem.config.js` - PM2 é…ç½®æ–‡ä»¶
- `deploy.sh` - éƒ¨ç½²è„šæœ¬
- `.env` - ç¯å¢ƒå˜é‡é…ç½®

